<!DOCTYPE html>
<html>

<head>
    <title>Spatial Signatures in Great Britain</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- load leaflet.js -->
    <!-- load CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- load JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- load VectorGrid extension -->
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
</head>

<body style='margin:0'>
    <!-- div containing map -->
    <div id="map" style="width: 100vw; height: 100vh; background: #fdfdfd"></div>
    <!-- specification of leaflet map -->
    <script>
        // create map
        var map = L.map('map', {
            center: [53.4107, -2.9704],
            minZoom: 6,
            maxZoom: 15,
            zoomControl: true,
            zoom: 12,
        });

        // add background basemap
        var mapBaseLayer = L.tileLayer(
            'https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png', {
                attribution: '(C) OpenStreetMap contributors (C) CARTO'
            }
        ).addTo(map);

        // get vector tiles URL
        var mapUrl = "https://urbangrammarai.xyz/great-britain/tiles/{z}/{x}/{y}.pbf";

        // mapping of colors to signature types
        const cmap = {
            "0_0": "#f2e6c7",
            "1_0": "#8fa37e",
            "3_0": "#d7a59f",
            "4_0": "#d7ded1",
            "5_0": "#c3abaf",
            "6_0": "#e4cbc8",
            "7_0": "#c2d0d9",
            "8_0": "#f0d17d",
            "2_0": "#678ea6",
            "2_1": "#94666e",
            "2_2": "#efc758",
            "9_0": "#3b6e8c",
            "9_1": "#333432",
            "9_2": "#ab888e",
            "9_3": "#c1c1c0",
            "9_4": "#bc5b4f",
            "9_5": "#a7b799",
            "9_6": "#c1c1c0",
            "9_7": "#c1c1c0",
            "9_8": "#c1c1c0"
        };

        // mapping of names to signature types to be shown in popup on click
        const popup_info = {
            "0_0": "Countryside agriculture",
            "1_0": "Accessible suburbia",
            "3_0": "Open sprawl",
            "4_0": "Wild countryside",
            "5_0": "Warehouse/Park land",
            "6_0": "Gridded residential quarters",
            "7_0": "Urban buffer",
            "8_0": "Disconnected suburbia",
            "2_0": "Dense residential neighbourhoods",
            "2_1": "Connected residential neighbourhoods",
            "2_2": "Dense urban neighbourhoods",
            "9_0": "Local urbanity",
            "9_1": "Concentrated urbanity",
            "9_2": "Regional urbanity",
            "9_4": "Metropolitan urbanity",
            "9_5": "Hyper concentrated urbanity",
        };

        // define styling of vector tiles
        var vectorTileStyling = {
            signatures_combined_levels_clipped_4326: function(properties, zoom) {
                // set line weight conditionally based on zoom
                var weight = 0;
                if (zoom > 12) {
                    weight = 1.0;
                }
                return ({
                    fill: true,
                    fillColor: cmap[properties.signature_type],
                    fillOpacity: 0.9,
                    weight: weight, // pass the weight variable instead of a value
                    color: "#ffffff",
                    opacity: 1.0,
                });
            }
        }

        // define options of vector tiles
        var mapVectorTileOptions = {
            rendererFactory: L.canvas.tile,
            interactive: true,
            attribution: '(C) Martin Fleischmann',
            maxNativeZoom: 15,
            minZoom: 6,
            vectorTileLayerStyles: vectorTileStyling,
        };

        // create VectorGrid layer
        var mapPbfLayer = new L.VectorGrid.Protobuf(
            mapUrl, mapVectorTileOptions
        ).on('click', function(e) { // this line and below
            L.popup()
                .setContent(popup_info[e.layer.properties.signature_type])
                .setLatLng(e.latlng)
                .openOn(map);
        });

        // add VectorGrid layer to map
        mapPbfLayer.addTo(map);

        // add labels basemap
        var mapBaseLayer = L.tileLayer(
            'https://{s}.basemaps.cartocdn.com/rastertiles/light_only_labels/{z}/{x}/{y}.png', {
                attribution: '(C) OpenStreetMap contributors (C) CARTO'
            }
        ).addTo(map);
    </script>
</body>

</html>